"""
Bot Command Handlers
Telegram command handlers for the bot
"""
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import ContextTypes
from typing import Optional

# Import from core
from bot.core import bot
from strategies.manager import analyze_market

# Default referral link (can be moved to settings)
REFERRAL_LINK = "https://pocket-friends.com/r/ugauihalod"


async def start_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Handle /start command"""
    user = update.effective_user
    bot.add_user(user.id, user.username, user.first_name)
    
    welcome_text = """
üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Crypto Signals Bot!

–Ø –∞–Ω–∞–ª–∏–∑–∏—Ä—É—é —Ä—ã–Ω–æ–∫ –∏ –¥–∞—é —Ç–æ—Ä–≥–æ–≤—ã–µ —Å–∏–≥–Ω–∞–ª—ã —Å –≤—ã—Å–æ–∫–æ–π —Ç–æ—á–Ω–æ—Å—Ç—å—é.

üìä –ö–æ–º–∞–Ω–¥—ã:
‚Ä¢ /short - –ø–æ–ª—É—á–∏—Ç—å SHORT —Å–∏–≥–Ω–∞–ª (1-5 –º–∏–Ω)
‚Ä¢ /long - –ø–æ–ª—É—á–∏—Ç—å LONG —Å–∏–≥–Ω–∞–ª (1-4 —á–∞—Å–∞)
‚Ä¢ /my_stats - –≤–∞—à–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
‚Ä¢ /set_bank [—Å—É–º–º–∞] - —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–∞–Ω–∫
‚Ä¢ /set_strategy - –≤—ã–±—Ä–∞—Ç—å —Å—Ç—Ä–∞—Ç–µ–≥–∏—é

üöÄ –ù–∞—á–Ω–∏—Ç–µ —Å /short –∏–ª–∏ /long
"""
    
    keyboard = [
        [InlineKeyboardButton("‚ö° SHORT", callback_data="get_short_signal")],
        [InlineKeyboardButton("üîµ LONG", callback_data="get_long_signal")],
        [InlineKeyboardButton("üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", callback_data="my_stats")]
    ]
    
    await update.message.reply_text(
        welcome_text,
        reply_markup=InlineKeyboardMarkup(keyboard)
    )


async def short_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Handle /short command - get short timeframe signal"""
    user_id = update.effective_user.id
    bot.add_user(user_id, update.effective_user.username, update.effective_user.first_name)

    # Check quota
    if not bot.can_use_signal(user_id, max_free_per_day=3):
        await update.message.reply_text(
            f"üìõ –õ–∏–º–∏—Ç –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö —Å–∏–≥–Ω–∞–ª–æ–≤ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç (3/–¥–µ–Ω—å).\n–ß—Ç–æ–±—ã —Å–Ω—è—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è, –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å –ø–æ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–µ: {REFERRAL_LINK}"
        )
        return

    await update.message.reply_text("‚ö° SHORT Signal ‚Äî –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞ –ø–æ–¥–æ–∂–¥–∏—Ç–µ...")

    # Generate short (fast) signal using statistical/strategy analyzer (placeholder)
    try:
        result = await analyze_market(asset="EURUSD", ticker="EURUSD", timeframe="5M")
        signal = result.get('signal', {}).get('signal', 'neutral') if result else 'neutral'
        confidence = result.get('signal', {}).get('confidence', 0) if result else 0
        price = result.get('signal', {}).get('price', 0) if result else 0

        # Save and increment quota
        bot.save_signal(user_id, asset="EURUSD", timeframe="5M", signal_type="short", entry_price=price, stake_amount=0, confidence=confidence)
        bot.increment_signal_count(user_id)

        await update.message.reply_text(f"‚ö° SHORT: {signal.upper()} | Confidence: {confidence}% | Asset: EURUSD")
    except Exception as e:
        await update.message.reply_text("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–∏–≥–Ω–∞–ª–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")


async def long_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Handle /long command - get long timeframe signal"""
    user_id = update.effective_user.id
    bot.add_user(user_id, update.effective_user.username, update.effective_user.first_name)

    # Check quota
    if not bot.can_use_signal(user_id, max_free_per_day=3):
        await update.message.reply_text(
            f"üìõ –õ–∏–º–∏—Ç –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö —Å–∏–≥–Ω–∞–ª–æ–≤ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç (3/–¥–µ–Ω—å).\n–ß—Ç–æ–±—ã —Å–Ω—è—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è, –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å –ø–æ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–µ: {REFERRAL_LINK}"
        )
        return

    await update.message.reply_text("üîµ LONG Signal ‚Äî –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è (OpenRouter), –ø–æ–¥–æ–∂–¥–∏—Ç–µ...")

    try:
        # Long signals should be generated by OpenRouter/AI ‚Äî placeholder uses strategy analyzer
        result = await analyze_market(asset="BTC-USD", ticker="BTC-USD", timeframe="1H")
        signal = result.get('signal', {}).get('signal', 'neutral') if result else 'neutral'
        confidence = result.get('signal', {}).get('confidence', 0) if result else 0
        price = result.get('signal', {}).get('price', 0) if result else 0

        bot.save_signal(user_id, asset="BTC-USD", timeframe="1H", signal_type="long", entry_price=price, stake_amount=0, confidence=confidence)
        bot.increment_signal_count(user_id)

        await update.message.reply_text(f"üîµ LONG: {signal.upper()} | Confidence: {confidence}% | Asset: BTC-USD")
    except Exception as e:
        await update.message.reply_text("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ LONG —Å–∏–≥–Ω–∞–ª–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")


async def my_stats_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Handle /my_stats command"""
    user_id = update.effective_user.id
    
    stats = bot.get_user_stats(user_id)
    balance = bot.get_user_balance(user_id)
    strategy = bot.get_user_strategy(user_id)
    
    text = f"""
üìä –í–∞—à–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

üí∞ –ë–∞–Ω–∫: {balance:.0f}‚ÇΩ
üìà –°—Ç—Ä–∞—Ç–µ–≥–∏—è: {strategy}

üìä –í—Å–µ–≥–æ —Å–¥–µ–ª–æ–∫: {stats['total']}
‚úÖ Wins: {stats['wins']}
‚ùå Losses: {stats['losses']}
üìà Win Rate: {stats['win_rate']:.1f}%
"""
    
    await update.message.reply_text(text)


async def set_bank_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Handle /set_bank command"""
    user_id = update.effective_user.id
    
    if context.args:
        try:
            balance = float(context.args[0])
            bot.set_user_balance(user_id, balance)
            await update.message.reply_text(f"‚úÖ –ë–∞–Ω–∫ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: {balance}‚ÇΩ")
        except ValueError:
            await update.message.reply_text("‚ùå –ù–µ–≤–µ—Ä–Ω–∞—è —Å—É–º–º–∞. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: /set_bank 10000")
    else:
        balance = bot.get_user_balance(user_id)
        await update.message.reply_text(f"üí∞ –¢–µ–∫—É—â–∏–π –±–∞–Ω–∫: {balance}‚ÇΩ\n\n–ò–∑–º–µ–Ω–∏—Ç—å: /set_bank [—Å—É–º–º–∞]")


async def set_strategy_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Handle /set_strategy command"""
    user_id = update.effective_user.id
    
    current = bot.get_user_strategy(user_id)
    
    text = f"""
üéØ –í—ã–±–æ—Ä —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏

–¢–µ–∫—É—â–∞—è: {current}

–î–æ—Å—Ç—É–ø–Ω—ã–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏:
‚Ä¢ martingale - –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π –º–∞—Ä—Ç–∏–Ω–≥–µ–π–ª (x3)
‚Ä¢ percentage - –ø—Ä–æ—Ü–µ–Ω—Ç –æ—Ç –¥–µ–ø–æ–∑–∏—Ç–∞ (2.5%)
‚Ä¢ dalembert - —Å–∏—Å—Ç–µ–º–∞ –¥'–ê–ª–∞–º–±–µ—Ä–∞
‚Ä¢ conservative - –∫–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω–∞—è (1%)

–ò–∑–º–µ–Ω–∏—Ç—å: /set_strategy [–Ω–∞–∑–≤–∞–Ω–∏–µ]
"""
    
    keyboard = [
        [InlineKeyboardButton("üé∞ Martingale", callback_data="set_strategy_martingale")],
        [InlineKeyboardButton("üìà Percentage", callback_data="set_strategy_percentage")],
        [InlineKeyboardButton("üé≤ D'Alembert", callback_data="set_strategy_dalembert")],
        [InlineKeyboardButton("üõ°Ô∏è Conservative", callback_data="set_strategy_conservative")]
    ]
    
    await update.message.reply_text(
        text,
        reply_markup=InlineKeyboardMarkup(keyboard)
    )


async def help_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Handle /help command"""
    text = """
üìñ –°–ø—Ä–∞–≤–∫–∞ –ø–æ –∫–æ–º–∞–Ω–¥–∞–º

–û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:
‚Ä¢ /start - –Ω–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É
‚Ä¢ /short - SHORT —Å–∏–≥–Ω–∞–ª (1-5 –º–∏–Ω)
‚Ä¢ /long - LONG —Å–∏–≥–Ω–∞–ª (1-4 —á–∞—Å–∞)
‚Ä¢ /my_stats - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
‚Ä¢ /set_bank - —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–∞–Ω–∫
‚Ä¢ /set_strategy - –≤—ã–±—Ä–∞—Ç—å —Å—Ç—Ä–∞—Ç–µ–≥–∏—é

–û—Ç—á–µ—Ç—ã:
‚Ä¢ /report_win - —Å–æ–æ–±—â–∏—Ç—å –æ –≤—ã–∏–≥—Ä—ã—à–µ
‚Ä¢ /report_loss - —Å–æ–æ–±—â–∏—Ç—å –æ –ø—Ä–æ–∏–≥—Ä—ã—à–µ

–ê–¥–º–∏–Ω:
‚Ä¢ /admin_panel - –ø–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∞
"""
    await update.message.reply_text(text)


async def report_win_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Handle /report_win command"""
    user_id = update.effective_user.id
    # Get last signal and update result
    signals = bot.get_user_signals(user_id, 1)
    if signals:
        bot.update_signal_result(signals[0]['id'], 'win')
        await update.message.reply_text("‚úÖ –û—Ç–º–µ—á–µ–Ω–æ –∫–∞–∫ WIN!")
    else:
        await update.message.reply_text("‚ùå –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–∏–≥–Ω–∞–ª–æ–≤")


async def report_loss_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Handle /report_loss command"""
    user_id = update.effective_user.id
    signals = bot.get_user_signals(user_id, 1)
    if signals:
        bot.update_signal_result(signals[0]['id'], 'loss')
        await update.message.reply_text("‚úÖ –û—Ç–º–µ—á–µ–Ω–æ –∫–∞–∫ LOSS!")
    else:
        await update.message.reply_text("‚ùå –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–∏–≥–Ω–∞–ª–æ–≤")

async def photo_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Handle incoming photo (screenshot) from user"""
    user_id = update.effective_user.id
    bot.add_user(user_id, update.effective_user.username, update.effective_user.first_name)

    if not update.message.photo:
        await update.message.reply_text("‚ùå –ù–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞")
        return

    # Get highest resolution photo
    photo = update.message.photo[-1]
    file = await context.bot.get_file(photo.file_id)
    img_bytes = await file.download_as_bytearray()

    await update.message.reply_text("üîé –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é —Å–∫—Ä–∏–Ω—à–æ—Ç, –ø–æ–¥–æ–∂–¥–∏—Ç–µ...")

    analysis = analyze_screenshot(bytes(img_bytes))
    # Save analysis to DB
    try:
        bot.db.save_screenshot_analysis(user_id, analysis)
    except Exception:
        pass

    # Respond with summary
    summary = analysis.get('notes', '–ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à—ë–Ω')
    await update.message.reply_text(f"‚úÖ –ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à—ë–Ω:\n{summary}")

# Command list for bot setup
COMMANDS = [
    ("start", "–ù–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É —Å –±–æ—Ç–æ–º"),
    ("short", "SHORT —Å–∏–≥–Ω–∞–ª"),
    ("long", "LONG —Å–∏–≥–Ω–∞–ª"),
    ("my_stats", "–í–∞—à–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞"),
    ("set_bank", "–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–∞–Ω–∫"),
    ("set_strategy", "–í—ã–±—Ä–∞—Ç—å —Å—Ç—Ä–∞—Ç–µ–≥–∏—é"),
    ("report_win", "–û—Ç—á–µ—Ç –æ –≤—ã–∏–≥—Ä—ã—à–µ"),
    ("report_loss", "–û—Ç—á–µ—Ç –æ –ø—Ä–æ–∏–≥—Ä—ã—à–µ"),
    ("help", "–ü–æ–º–æ—â—å"),
]
